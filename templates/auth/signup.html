{% extends 'base.html' %} {% load crispy_forms_tags %} {% block content %}

<div class="container">
    <div class="container">
        <div class="row">
            <div class="col-lg-12">
                <div class="page-header">
                    <h2 id="navbars">
                        <br>User Registration </h2>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-lg-8" style="margin-left:auto;margin-right:auto;">
                <div class="bs-component">
                    <div class="card border-primary mb-3" style="max-width: 40rem;">
                        <div class="card-header">Create a new user account</div>
                        <div class="card-body">
                            <form role="form" method="post" action="{% url 'signup' %}" class="js-register-account-form" id="signup-form">
                                {% csrf_token %}
                              
                                
                                <div class="modal-body">
                                    <div id="div_id_first_name" class="form-group">
                                        <label for="username" class="control-label  requiredField">Username<span class="asteriskField">*</span></label>
                                        <div class="form-group has-feedback">
                                            <input type="text" onkeypress="return blockSpecialChar(event)" name="username" maxlength="30" class="textinput textInput form-control" required="" id="id_first_name" value="">
                                            <span class="glyphicon glyphicon-user form-control-feedback"></span>
                                            <p id="hint_id_first_name" class="help-block">Enter Username</p>
                                        </div>
                                    </div>
                              
                              
                                    <div id="div_id_password1" class="form-group {% if form.password1.errors %} has-error{% endif %}">
                                        <label for="id_password1" class="control-label requiredField">Password or Passphrase<span class="asteriskField">*</span> </label>
                                        <div class="form-group has-feedback">
                                            <input type="password" name="password1" class="textinput textInput form-control" required="" id="id_password1" minlength="8" maxlength="128">
                                            <span class="glyphicon glyphicon-lock form-control-feedback"></span>
                                            
                                            <div id="strength-container" style="margin-top: 10px;">
                                                <label>Password Strength:</label>
                                                <div id="strength-bar-container" style="background-color: #e0e0e0; border-radius: 4px; height: 20px; width: 100%;">
                                                    <div id="strength-bar" style="height: 100%; border-radius: 4px; width: 0%; transition: width 0.3s, background-color 0.3s;"></div>
                                                </div>
                                                <div id="strength-text" style="margin-top: 5px; font-weight: bold;"></div>
                                            </div>
                                            
                                            <div id="password_feedback" style="margin-top: 10px;">
                                                <div class="alert alert-info" style="padding: 10px;">
                                                    <strong>Tips for a strong password:</strong>
                                                    <ul style="margin-bottom: 0; padding-left: 20px;">
                                                        <li>Use a passphrase - a sequence of random words (e.g., "correct horse battery staple")</li>
                                                        <li>Longer is stronger - aim for at least 15 characters</li>
                                                        <li>Avoid personal information like names or birthdays</li>
                                                        <li>Use a unique password for every site</li>
                                                    </ul>
                                                </div>
                                            </div>
                                            
                                            <div id="password_warnings" style="margin-top: 10px; display: none;"></div>
                                            <div id="breach_warning" style="margin-top: 10px; display: none;"></div>
                                            <input type="hidden" id="password_valid" name="password_valid" value="false">

                                        </div>
                                    </div>
                              
                                    <div id="div_id_password2" class="form-group {% if form.password2.errors %} has-error{% endif %}">
                                        <label for="id_password2" class="control-label  requiredField">Confirm Password<span class="asteriskField">*</span> </label>
                                        <div class="form-group has-feedback">
                                            <input type="password" name="password2" class="textinput textInput form-control" required="" id="id_password2" minlength="8" maxlength="128">
                                            <span class="glyphicon glyphicon-log-in form-control-feedback"></span>
                                            {% if form.password2.errors %}
                                              {% for error in form.password2.errors %}
                                                <p class="help-block text-danger">{{ error }}</p>
                                              {% endfor %}
                                            {% else %}
                                              <p id="hint_id_password2" class="help-block">Enter the same password as before, for verification.</p>
                                            {% endif %}
                                            <div id="password_match" style="margin-top: 5px;"></div>
                                        </div>
                                    </div>
                              
                                </div>
                                <div class="modal-footer">
                                  <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                                  <button type="submit" class="btn btn-primary js-register-account-button" id="submit-btn">Register</button>
                                </div>
                              </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <input type="hidden" id="message" value="{{message}}">
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.9-1/crypto-js.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/zxcvbn/4.4.2/zxcvbn.js"></script>
    <script>
        var passwordInput = document.getElementById("id_password1");
        var confirmInput = document.getElementById("id_password2");
        var strengthBar = document.getElementById("strength-bar");
        var strengthText = document.getElementById("strength-text");
        var passwordWarnings = document.getElementById("password_warnings");
        var breachWarning = document.getElementById("breach_warning");
        var passwordMatch = document.getElementById("password_match");
        var passwordValid = document.getElementById("password_valid");
        var submitBtn = document.getElementById("submit-btn");
        
        // Strength level colors and labels
        var strengthLevels = [
            { color: '#dc3545', label: 'Very Weak', minScore: 0 },
            { color: '#fd7e14', label: 'Weak', minScore: 1 },
            { color: '#ffc107', label: 'Fair', minScore: 2 },
            { color: '#28a745', label: 'Strong', minScore: 3 },
            { color: '#20c997', label: 'Very Strong', minScore: 4 }
        ];
        
        var isBreached = false;
        var currentStrengthScore = 0;
        
        function updateStrengthMeter(password) {
            if (!password || password.length === 0) {
                strengthBar.style.width = '0%';
                strengthBar.style.backgroundColor = '#e0e0e0';
                strengthText.textContent = '';
                passwordWarnings.style.display = 'none';
                currentStrengthScore = 0;
                updateSubmitButton();
                return;
            }
            
            // Use zxcvbn for password strength analysis
            var result = zxcvbn(password);
            currentStrengthScore = result.score;
            
            // Update strength bar
            var percentage = ((result.score + 1) / 5) * 100;
            strengthBar.style.width = percentage + '%';
            strengthBar.style.backgroundColor = strengthLevels[result.score].color;
            strengthText.textContent = strengthLevels[result.score].label;
            strengthText.style.color = strengthLevels[result.score].color;
            
            // Show feedback from zxcvbn
            var warningHtml = '';
            if (result.feedback.warning) {
                warningHtml += '<div class="alert alert-warning"><span class="glyphicon glyphicon-warning-sign"></span> ' + result.feedback.warning + '</div>';
            }
            if (result.feedback.suggestions && result.feedback.suggestions.length > 0) {
                warningHtml += '<div class="alert alert-info"><strong>Suggestions:</strong><ul style="margin-bottom: 0;">';
                result.feedback.suggestions.forEach(function(suggestion) {
                    warningHtml += '<li>' + suggestion + '</li>';
                });
                warningHtml += '</ul></div>';
            }
            
            if (warningHtml) {
                passwordWarnings.innerHTML = warningHtml;
                passwordWarnings.style.display = 'block';
            } else {
                passwordWarnings.style.display = 'none';
            }
            
            updateSubmitButton();
        }
        
        function checkPasswordBreach(password) {
            if (!password || password.length < 8) {
                isBreached = false;
                breachWarning.style.display = 'none';
                updateSubmitButton();
                return;
            }
            
            var hashedPassword = CryptoJS.SHA1(password);
            var hashHex = CryptoJS.enc.Hex.stringify(hashedPassword).toUpperCase();
            var prefix = hashHex.substring(0, 5);
            var suffix = hashHex.slice(5);
            
            // Use Troy Hunt's HIBP API with k-anonymity
            $.ajax({
                type: "GET",
                dataType: "text",
                url: "https://api.pwnedpasswords.com/range/" + prefix,
                success: function(data) {
                    if (data.includes(suffix)) {
                        isBreached = true;
                        breachWarning.innerHTML = '<div class="alert alert-danger"><span class="glyphicon glyphicon-exclamation-sign"></span> <strong>Warning:</strong> This password has been found in data breaches. Please choose a different password.</div>';
                        breachWarning.style.display = 'block';
                    } else {
                        isBreached = false;
                        breachWarning.style.display = 'none';
                    }
                    updateSubmitButton();
                },
                error: function() {
                    // If the API fails, don't block the user
                    isBreached = false;
                    breachWarning.style.display = 'none';
                    updateSubmitButton();
                }
            });
        }
        
        function checkPasswordMatch() {
            var password = passwordInput.value;
            var confirm = confirmInput.value;
            
            if (confirm.length === 0) {
                passwordMatch.innerHTML = '';
                return;
            }
            
            if (password === confirm) {
                passwordMatch.innerHTML = '<span style="color: #28a745;"><span class="glyphicon glyphicon-ok"></span> Passwords match</span>';
            } else {
                passwordMatch.innerHTML = '<span style="color: #dc3545;"><span class="glyphicon glyphicon-remove"></span> Passwords do not match</span>';
            }
            updateSubmitButton();
        }
        
        function updateSubmitButton() {
            var password = passwordInput.value;
            var confirm = confirmInput.value;
            var passwordsMatch = password === confirm && password.length >= 8;
            var isStrong = currentStrengthScore >= 2; // Fair or better
            var notBreached = !isBreached;
            
            if (passwordsMatch && isStrong && notBreached) {
                passwordValid.value = 'true';
                submitBtn.disabled = false;
            } else {
                passwordValid.value = 'false';
                // Don't disable the button, let server-side validation handle edge cases
                submitBtn.disabled = false;
            }
        }
        
        function delayTyping(callback, ms) {
            var timer = 0;
            return function() {
                var context = this, args = arguments;
                clearTimeout(timer);
                timer = setTimeout(function() {
                    callback.apply(context, args);
                }, ms || 0);
            };
        }
        
        // Password input event handlers
        passwordInput.addEventListener("keyup", delayTyping(function() {
            var password = passwordInput.value;
            updateStrengthMeter(password);
            checkPasswordBreach(password);
            checkPasswordMatch();
        }, 300));
        
        confirmInput.addEventListener("keyup", function() {
            checkPasswordMatch();
        });
        
        function blockSpecialChar(e) {
            var k;
            document.all ? k = e.keyCode : k = e.which;
            return ((k > 64 && k < 91) || (k > 96 && k < 123) || k == 8 || k == 32 || (k >= 48 && k <= 57) || k == 95 || k == 45);
        }
    </script>
    <script>
        var message = document.getElementById("message").value;
        if (message) {
            alert('{{ message|json_script:"message" }}');
        }
    </script>
    {% endblock %}